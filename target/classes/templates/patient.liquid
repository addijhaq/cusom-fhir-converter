{
  "resourceType": "Patient",
  "id": "{{ id | default: uuid }}",
  "meta": {
    "profile": ["http://hl7.org/fhir/StructureDefinition/Patient"]
  },
  "identifier": [
    {% assign id_count = 0 %}
    {% comment %} SSN with automatic formatting {% endcomment %}
    {% if ssn %}
      {% if id_count > 0 %},{% endif %}
      {{ ssn | fhir_identifier: 'SSN' | json }}
      {% assign id_count = id_count | plus: 1 %}
    {% endif %}
    {% comment %} MRN {% endcomment %}
    {% if mrn or medical_record_number %}
      {% if id_count > 0 %},{% endif %}
      {{ mrn | default: medical_record_number | fhir_identifier: 'MRN' | json }}
      {% assign id_count = id_count | plus: 1 %}
    {% endif %}
    {% comment %} Driver's License {% endcomment %}
    {% if drivers_license %}
      {% if id_count > 0 %},{% endif %}
      {{ drivers_license | fhir_identifier: 'DL' | json }}
      {% assign id_count = id_count | plus: 1 %}
    {% endif %}
    {% comment %} Array of identifiers {% endcomment %}
    {% if identifiers %}
      {% for identifier in identifiers %}
        {% if id_count > 0 %},{% endif %}
        {
          "system": "{{ identifier.system }}",
          "value": "{{ identifier.value }}"
          {% if identifier.type %}
          ,"type": {
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
              "code": "{{ identifier.type }}",
              "display": "{{ identifier.type_display }}"
            }]
          }
          {% endif %}
        }
        {% assign id_count = id_count | plus: 1 %}
      {% endfor %}
    {% endif %}
    {% comment %} Default identifier {% endcomment %}
    {% if identifier_value %}
      {% if id_count > 0 %},{% endif %}
      {
        "system": "{{ identifier_system | default: 'urn:oid:1.2.3.4.5' }}",
        "value": "{{ identifier_value }}"
      }
    {% endif %}
  ],
  "active": {{ active | default: true }},
  "name": [
    {% if full_name %}
      {{ full_name | fhir_name_parts | json }}
    {% elsif names %}
      {% for name in names %}
        {
          "use": "{{ name.use | default: 'official' }}",
          "family": "{{ name.family }}",
          "given": {{ name.given | json }}
          {% if name.prefix %},
          "prefix": {{ name.prefix | json }}
          {% endif %}
          {% if name.suffix %},
          "suffix": {{ name.suffix | json }}
          {% endif %}
          {% if name.period %},
          "period": {
            "start": "{{ name.period.start | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
            {% if name.period.end %},
            "end": "{{ name.period.end | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
            {% endif %}
          }
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% else %}
      {
        "use": "official",
        "family": "{{ family_name }}",
        "given": {{ given_names | json }}
      }
    {% endif %}
  ]
  {% comment %} Gender handling {% endcomment %}
  {% if gender %}
  {% assign gender_lower = gender | downcase %}
  ,"gender": "{% case gender_lower %}{% when 'm', 'male' %}male{% when 'f', 'female' %}female{% when 'o', 'other' %}other{% when 'u', 'unknown' %}unknown{% else %}{{ gender | fhir_code: 'gender' }}{% endcase %}"
  {% endif %}
  {% comment %} Birth date {% endcomment %}
  {% if birth_date %}
  ,"birthDate": "{{ birth_date | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
  {% elsif date_of_birth %}
  ,"birthDate": "{{ date_of_birth | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
  {% endif %}
  {% comment %} Deceased status {% endcomment %}
  {% if deceased %}
    {% if deceased == true or deceased == "true" %}
    ,"deceasedBoolean": true
    {% endif %}
  {% endif %}
  {% if deceased_date %}
  ,"deceasedDateTime": "{{ deceased_date | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
  {% endif %}
  {% comment %} Marital status {% endcomment %}
  {% if marital_status %}
  ,"maritalStatus": {
    "coding": [{
      "system": "http://terminology.hl7.org/CodeSystem/v3-MaritalStatus",
      "code": "{{ marital_status | fhir_code: 'marital' }}",
      "display": "{{ marital_status_display | default: marital_status }}"
    }]
  }
  {% endif %}
  {% comment %} Telecom entries {% endcomment %}
  {% if phone or phones or mobile or work_phone or email or emails or fax %}
  ,"telecom": [
    {% assign telecom_count = 0 %}
    {% if phone %}
      {{ phone | fhir_phone: 'home' | json }}
      {% assign telecom_count = telecom_count | plus: 1 %}
    {% endif %}
    {% if mobile %}
      {% if telecom_count > 0 %},{% endif %}
      {{ mobile | fhir_phone: 'mobile' | json }}
      {% assign telecom_count = telecom_count | plus: 1 %}
    {% endif %}
    {% if work_phone %}
      {% if telecom_count > 0 %},{% endif %}
      {{ work_phone | fhir_phone: 'work' | json }}
      {% assign telecom_count = telecom_count | plus: 1 %}
    {% endif %}
    {% if fax %}
      {% if telecom_count > 0 %},{% endif %}
      {
        "system": "fax",
        "value": "{{ fax }}",
        "use": "work"
      }
      {% assign telecom_count = telecom_count | plus: 1 %}
    {% endif %}
    {% if email %}
      {% if telecom_count > 0 %},{% endif %}
      {
        "system": "email",
        "value": "{{ email }}",
        "use": "home"
      }
      {% assign telecom_count = telecom_count | plus: 1 %}
    {% endif %}
    {% comment %} Array of phones {% endcomment %}
    {% if phones %}
      {% for phone_item in phones %}
        {% if telecom_count > 0 %},{% endif %}
        {% if phone_item.number %}
          {{ phone_item.number | fhir_phone: phone_item.use | default: 'home' | json }}
        {% else %}
          {{ phone_item | fhir_phone: 'home' | json }}
        {% endif %}
        {% assign telecom_count = telecom_count | plus: 1 %}
      {% endfor %}
    {% endif %}
    {% comment %} Array of emails {% endcomment %}
    {% if emails %}
      {% for email_item in emails %}
        {% if telecom_count > 0 %},{% endif %}
        {
          "system": "email",
          {% if email_item.address %}
          "value": "{{ email_item.address }}",
          "use": "{{ email_item.use | default: 'home' }}"
          {% else %}
          "value": "{{ email_item }}",
          "use": "home"
          {% endif %}
        }
        {% assign telecom_count = telecom_count | plus: 1 %}
      {% endfor %}
    {% endif %}
  ]
  {% endif %}
  {% comment %} Address handling {% endcomment %}
  {% if simple_address or address or addresses %}
  ,"address": [
    {% if simple_address %}
      {{ simple_address | fhir_address | json }}
    {% elsif addresses %}
      {% for addr in addresses %}
        {
          "use": "{{ addr.use | default: 'home' }}",
          {% if addr.type %}"type": "{{ addr.type }}",{% endif %}
          {% if addr.lines %}
          "line": {{ addr.lines | json }},
          {% elsif addr.street %}
          "line": ["{{ addr.street }}"],
          {% endif %}
          {% if addr.city %}"city": "{{ addr.city }}",{% endif %}
          {% if addr.state %}"state": "{{ addr.state }}",{% endif %}
          {% if addr.postal_code %}"postalCode": "{{ addr.postal_code }}",{% elsif addr.postalCode %}"postalCode": "{{ addr.postalCode }}",{% endif %}
          "country": "{{ addr.country | default: 'US' }}"
          {% if addr.period %},
          "period": {
            "start": "{{ addr.period.start | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
            {% if addr.period.end %},
            "end": "{{ addr.period.end | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
            {% endif %}
          }
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% elsif address %}
      {
        "use": "{{ address.use | default: 'home' }}",
        {% if address.lines %}
        "line": {{ address.lines | json }},
        {% elsif address.street %}
        "line": ["{{ address.street }}"],
        {% endif %}
        {% if address.city %}"city": "{{ address.city }}",{% endif %}
        {% if address.state %}"state": "{{ address.state }}",{% endif %}
        {% if address.postal_code %}"postalCode": "{{ address.postal_code }}",{% elsif address.postalCode %}"postalCode": "{{ address.postalCode }}",{% endif %}
        "country": "{{ address.country | default: 'US' }}"
      }
    {% endif %}
  ]
  {% endif %}
  {% comment %} Contact persons (emergency contacts, next of kin) {% endcomment %}
  {% if contacts or emergency_contact %}
  ,"contact": [
    {% assign contact_count = 0 %}
    {% if emergency_contact %}
      {
        "relationship": [{
          "coding": [{
            "system": "http://terminology.hl7.org/CodeSystem/v2-0131",
            "code": "C",
            "display": "Emergency Contact"
          }]
        }],
        "name": {
          "text": "{{ emergency_contact.name }}"
        }
        {% if emergency_contact.phone %}
        ,"telecom": [
          {{ emergency_contact.phone | fhir_phone: 'mobile' | json }}
        ]
        {% endif %}
      }
      {% assign contact_count = contact_count | plus: 1 %}
    {% endif %}
    {% if contacts %}
      {% for contact in contacts %}
        {% if contact_count > 0 %},{% endif %}
        {
          {% if contact.relationship %}
          "relationship": [{
            "coding": [{
              "system": "http://terminology.hl7.org/CodeSystem/v2-0131",
              "code": "{{ contact.relationship_code | default: 'N' }}",
              "display": "{{ contact.relationship }}"
            }]
          }],
          {% endif %}
          "name": {
            {% if contact.full_name %}
              {% assign parsed_name = contact.full_name | fhir_name_parts %}
              "family": "{{ parsed_name.family }}",
              "given": {{ parsed_name.given | json }}
            {% else %}
              "text": "{{ contact.name }}"
            {% endif %}
          }
          {% if contact.phone or contact.email %}
          ,"telecom": [
            {% assign contact_telecom = 0 %}
            {% if contact.phone %}
              {{ contact.phone | fhir_phone: 'home' | json }}
              {% assign contact_telecom = 1 %}
            {% endif %}
            {% if contact.email %}
              {% if contact_telecom > 0 %},{% endif %}
              {
                "system": "email",
                "value": "{{ contact.email }}"
              }
            {% endif %}
          ]
          {% endif %}
        }
        {% assign contact_count = contact_count | plus: 1 %}
      {% endfor %}
    {% endif %}
  ]
  {% endif %}
  {% comment %} Communication preferences {% endcomment %}
  {% if languages or preferred_language %}
  ,"communication": [
    {% assign comm_count = 0 %}
    {% if preferred_language %}
      {
        "language": {
          "coding": [{
            "system": "urn:ietf:bcp:47",
            "code": "{{ preferred_language | downcase | truncate: 2, '' }}",
            "display": "{{ preferred_language }}"
          }]
        },
        "preferred": true
      }
      {% assign comm_count = comm_count | plus: 1 %}
    {% endif %}
    {% if languages %}
      {% for lang in languages %}
        {% if comm_count > 0 %},{% endif %}
        {
          "language": {
            "coding": [{
              "system": "urn:ietf:bcp:47",
              "code": "{{ lang.code | default: lang | downcase }}",
              "display": "{{ lang.display | default: lang }}"
            }]
          }
          {% if lang.preferred %}
          ,"preferred": {{ lang.preferred }}
          {% endif %}
        }
        {% assign comm_count = comm_count | plus: 1 %}
      {% endfor %}
    {% endif %}
  ]
  {% endif %}
  {% comment %} Extensions for race, ethnicity, birth sex {% endcomment %}
  {% if race or ethnicity or birth_sex %}
  ,"extension": [
    {% assign ext_count = 0 %}
    {% if race %}
      {
        "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
        "extension": [
          {
            "url": "ombCategory",
            "valueCoding": {
              "system": "urn:oid:2.16.840.1.113883.6.238",
              "code": "{{ race.code | default: race }}",
              "display": "{{ race.display | default: race }}"
            }
          },
          {
            "url": "text",
            "valueString": "{{ race.text | default: race.display | default: race }}"
          }
        ]
      }
      {% assign ext_count = ext_count | plus: 1 %}
    {% endif %}
    {% if ethnicity %}
      {% if ext_count > 0 %},{% endif %}
      {
        "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity",
        "extension": [
          {
            "url": "ombCategory",
            "valueCoding": {
              "system": "urn:oid:2.16.840.1.113883.6.238",
              "code": "{{ ethnicity.code | default: ethnicity }}",
              "display": "{{ ethnicity.display | default: ethnicity }}"
            }
          },
          {
            "url": "text",
            "valueString": "{{ ethnicity.text | default: ethnicity.display | default: ethnicity }}"
          }
        ]
      }
      {% assign ext_count = ext_count | plus: 1 %}
    {% endif %}
    {% if birth_sex %}
      {% if ext_count > 0 %},{% endif %}
      {
        "url": "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
        "valueCode": "{{ birth_sex | fhir_code: 'gender' }}"
      }
    {% endif %}
  ]
  {% endif %}
}