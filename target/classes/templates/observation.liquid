{
  "resourceType": "Observation",
  "id": "{{ id | default: uuid }}",
  "status": "{{ status | default: 'final' }}"
  {% comment %} Category {% endcomment %}
  {% if category or categories %}
  ,"category": [
    {% if categories %}
      {% for cat in categories %}
        {
          "coding": [{
            "system": "http://terminology.hl7.org/CodeSystem/observation-category",
            {% if cat.code %}
            "code": "{{ cat.code }}",
            "display": "{{ cat.display }}"
            {% else %}
            "code": "{{ cat }}"
            {% endif %}
          }]
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% else %}
      {
        "coding": [{
          "system": "http://terminology.hl7.org/CodeSystem/observation-category",
          "code": "{{ category }}"
        }]
      }
    {% endif %}
  ]
  {% endif %}
  ,"code": {
    "coding": [{
      "system": "{{ code_system | default: 'http://loinc.org' }}",
      "code": "{{ code }}",
      "display": "{{ code_display }}"
    }]
  }
  ,"subject": {
    "reference": "{{ patient_id | fhir_reference: 'Patient' }}"
  }
  {% comment %} Effective date/time {% endcomment %}
  {% if effective_date %}
  ,"effectiveDateTime": "{{ effective_date | fhir_date: 'MM/dd/yyyy HH:mm', 'yyyy-MM-dd' }}T00:00:00.000Z"
  {% elsif effective_instant %}
  ,"effectiveInstant": "{{ effective_instant | fhir_date: 'MM/dd/yyyy HH:mm:ss', 'yyyy-MM-dd' }}T00:00:00.000Z"
  {% endif %}
  {% comment %} Issued {% endcomment %}
  {% if issued %}
  ,"issued": "{{ issued | fhir_date: 'MM/dd/yyyy HH:mm:ss', 'yyyy-MM-dd' }}T00:00:00.000Z"
  {% endif %}
  {% comment %} Value handling {% endcomment %}
  {% if components %}
  ,"component": [
    {% for component in components %}
      {
        "code": {
          "coding": [{
            "system": "{{ component.code_system | default: 'http://loinc.org' }}",
            "code": "{{ component.code }}",
            "display": "{{ component.display }}"
          }]
        }
        {% if component.value and component.unit %}
        ,"valueQuantity": {
          "value": {{ component.value }},
          "unit": "{{ component.unit }}",
          "system": "http://unitsofmeasure.org",
          "code": "{{ component.unit_code | default: component.unit }}"
        }
        {% endif %}
        {% if component.reference_range %}
        ,"referenceRange": [{
          {% if component.reference_range.low %}
          "low": {
            "value": {{ component.reference_range.low }},
            "unit": "{{ component.reference_range.unit }}",
            "system": "http://unitsofmeasure.org",
            "code": "{{ component.reference_range.unit_code }}"
          }
          {% endif %}
          {% if component.reference_range.low and component.reference_range.high %},{% endif %}
          {% if component.reference_range.high %}
          "high": {
            "value": {{ component.reference_range.high }},
            "unit": "{{ component.reference_range.unit }}",
            "system": "http://unitsofmeasure.org",
            "code": "{{ component.reference_range.unit_code }}"
          }
          {% endif %}
        }]
        {% endif %}
        {% if component.interpretation %}
        ,"interpretation": [{
          "coding": [{
            "system": "http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation",
            "code": "{{ component.interpretation }}"
          }]
        }]
        {% endif %}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% elsif value and unit %}
  ,"valueQuantity": {
    "value": {{ value }},
    "unit": "{{ unit }}",
    "system": "http://unitsofmeasure.org",
    "code": "{{ unit_code | default: unit }}"
  }
  {% endif %}
  {% comment %} Reference range {% endcomment %}
  {% if reference_range or reference_ranges %}
  ,"referenceRange": [
    {% if reference_ranges %}
      {% for range in reference_ranges %}
        {
          {% if range.low %}
          "low": {
            "value": {{ range.low }},
            "unit": "{{ range.unit }}",
            "system": "http://unitsofmeasure.org",
            "code": "{{ range.unit_code }}"
          }
          {% endif %}
          {% if range.low and range.high %},{% endif %}
          {% if range.high %}
          "high": {
            "value": {{ range.high }},
            "unit": "{{ range.unit }}",
            "system": "http://unitsofmeasure.org",
            "code": "{{ range.unit_code }}"
          }
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% else %}
      {
        {% if reference_range.low %}
        "low": {
          "value": {{ reference_range.low }},
          "unit": "{{ reference_range.unit }}",
          "system": "http://unitsofmeasure.org",
          "code": "{{ reference_range.unit_code }}"
        }
        {% endif %}
        {% if reference_range.low and reference_range.high %},{% endif %}
        {% if reference_range.high %}
        "high": {
          "value": {{ reference_range.high }},
          "unit": "{{ reference_range.unit }}",
          "system": "http://unitsofmeasure.org",
          "code": "{{ reference_range.unit_code }}"
        }
        {% endif %}
      }
    {% endif %}
  ]
  {% endif %}
  {% comment %} Notes {% endcomment %}
  {% if notes or note %}
  ,"note": [
    {% if note %}
      {
        "text": "{{ note }}"
      }
    {% elsif notes %}
      {% for note in notes %}
        {
          "text": "{{ note.text }}"
          {% if note.author %}
          ,"authorString": "{{ note.author }}"
          {% endif %}
          {% if note.time %}
          ,"time": "{{ note.time | fhir_date: 'MM/dd/yyyy HH:mm', 'yyyy-MM-dd' }}T00:00:00.000Z"
          {% endif %}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ]
  {% endif %}
  {% comment %} Body site {% endcomment %}
  {% if body_site %}
  ,"bodySite": {
    "coding": [{
      "system": "http://snomed.info/sct",
      "code": "{{ body_site }}",
      "display": "{{ body_site_display }}"
    }]
  }
  {% endif %}
  {% comment %} Method {% endcomment %}
  {% if method %}
  ,"method": {
    "coding": [{
      "system": "http://snomed.info/sct",
      "code": "{{ method }}",
      "display": "{{ method_display }}"
    }]
  }
  {% endif %}
  {% comment %} Device {% endcomment %}
  {% if device_id %}
  ,"device": {
    "reference": "{{ device_id | fhir_reference: 'Device' }}"
  }
  {% endif %}
  {% comment %} Specimen {% endcomment %}
  {% if specimen_id %}
  ,"specimen": {
    "reference": "{{ specimen_id | fhir_reference: 'Specimen' }}"
  }
  {% endif %}
}