{
  "resourceType": "Bundle",
  "id": "{{ id | default: uuid }}",
  "type": "{{ bundle_type | default: 'transaction' }}",
  "timestamp": "{{ timestamp | default: now }}"
  {% if total %}
  ,"total": {{ total }}
  {% endif %}
  {% comment %} Bundle entries {% endcomment %}
  {% if entries %}
  ,"entry": [
    {% for entry in entries %}
      {
        {% comment %} Full URL for the entry {% endcomment %}
        {% if entry.fullUrl %}
        "fullUrl": "{{ entry.fullUrl }}",
        {% elsif entry.full_url %}
        "fullUrl": "{{ entry.full_url }}",
        {% elsif entry.resource_id %}
        "fullUrl": "urn:uuid:{{ entry.resource_id }}",
        {% elsif entry.patient_id %}
        "fullUrl": "urn:uuid:{{ entry.patient_id }}",
        {% elsif entry.observation_id %}
        "fullUrl": "urn:uuid:{{ entry.observation_id }}",
        {% elsif entry.encounter_id %}
        "fullUrl": "urn:uuid:{{ entry.encounter_id }}",
        {% elsif entry.medication_request_id %}
        "fullUrl": "urn:uuid:{{ entry.medication_request_id }}",
        {% else %}
        "fullUrl": "urn:uuid:entry-{{ forloop.index }}",
        {% endif %}
        {% comment %} Resource content {% endcomment %}
        {% if entry.resource %}
        "resource": {{ entry.resource | json }}
        {% elsif entry.resource_type == 'Patient' %}
        "resource": {
          "resourceType": "Patient",
          {% if entry.patient_id %}
          "id": "{{ entry.patient_id }}",
          {% endif %}
          {% if entry.full_name %}
          "name": [{{ entry.full_name | fhir_name_parts | json }}],
          {% endif %}
          {% if entry.gender %}
          {% assign gender_lower = entry.gender | downcase %}
          "gender": "{% case gender_lower %}{% when 'm', 'male' %}male{% when 'f', 'female' %}female{% else %}{{ entry.gender }}{% endcase %}",
          {% endif %}
          {% if entry.birth_date %}
          "birthDate": "{{ entry.birth_date | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}",
          {% endif %}
          {% if entry.phone %}
          "telecom": [{{ entry.phone | fhir_phone: 'home' | json }}],
          {% endif %}
          {% if entry.simple_address %}
          "address": [{{ entry.simple_address | fhir_address | json }}]
          {% endif %}
        }
        {% elsif entry.resource_type == 'Observation' %}
        "resource": {
          "resourceType": "Observation",
          "status": "{{ entry.status | default: 'final' }}",
          "code": {
            "coding": [{
              "system": "{{ entry.code_system | default: 'http://loinc.org' }}",
              "code": "{{ entry.code }}",
              "display": "{{ entry.code_display }}"
            }]
          },
          "subject": {
            "reference": "{{ entry.patient_reference | default: 'urn:uuid:' | append: entry.patient_id }}"
          }
          {% if entry.components %}
          ,"component": [
            {% for comp in entry.components %}
              {
                "code": {
                  "coding": [{
                    "system": "{{ comp.code_system | default: 'http://loinc.org' }}",
                    "code": "{{ comp.code }}",
                    "display": "{{ comp.display }}"
                  }]
                }
                {% if comp.value and comp.unit %}
                ,"valueQuantity": {
                  "value": {{ comp.value }},
                  "unit": "{{ comp.unit }}"
                }
                {% endif %}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
          {% endif %}
        }
        {% elsif entry.resource_type == 'Encounter' %}
        "resource": {
          "resourceType": "Encounter",
          "status": "{{ entry.status | default: 'finished' }}",
          "class": {
            "system": "http://terminology.hl7.org/CodeSystem/v3-ActCode",
            "code": "{{ entry.class | default: 'AMB' }}"
          },
          "subject": {
            "reference": "{{ entry.patient_reference | default: 'urn:uuid:' | append: entry.patient_id }}"
          }
        }
        {% elsif entry.resource_type == 'MedicationRequest' %}
        "resource": {
          "resourceType": "MedicationRequest",
          "status": "{{ entry.status | default: 'active' }}",
          "intent": "{{ entry.intent | default: 'order' }}",
          "subject": {
            "reference": "{{ entry.patient_reference | default: 'urn:uuid:' | append: entry.patient_id }}"
          },
          "medicationCodeableConcept": {
            "coding": [{
              "system": "{{ entry.medication_system | default: 'http://www.nlm.nih.gov/research/umls/rxnorm' }}",
              "code": "{{ entry.medication_code }}",
              "display": "{{ entry.medication_display }}"
            }]
          }
        }
        {% else %}
        "resource": {
          "resourceType": "{{ entry.resource_type }}",
          "id": "{{ entry.id | default: uuid }}"
        }
        {% endif %}
        {% comment %} Request for transaction bundles {% endcomment %}
        {% if bundle_type == 'transaction' or bundle_type == 'batch' %}
        ,"request": {
          "method": "{{ entry.method | default: 'POST' }}",
          {% if entry.url %}
          "url": "{{ entry.url }}"
          {% elsif entry.resource_type %}
          "url": "{{ entry.resource_type }}"
          {% elsif entry.resource.resourceType %}
          "url": "{{ entry.resource.resourceType }}"
          {% else %}
          "url": "Resource"
          {% endif %}
        }
        {% endif %}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
  {% endif %}
}