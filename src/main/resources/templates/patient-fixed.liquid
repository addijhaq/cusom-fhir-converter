{
  "resourceType": "Patient",
  "id": "{{ id | default: uuid }}",
  "meta": {
    "profile": ["http://hl7.org/fhir/StructureDefinition/Patient"]
  },
  "identifier": [
    {% assign id_count = 0 %}
    {% if ssn %}
      {% if id_count > 0 %},{% endif %}
      {{ ssn | fhir_identifier: 'SSN' | json }}
      {% assign id_count = id_count | plus: 1 %}
    {% endif %}
    {% if mrn or medical_record_number %}
      {% if id_count > 0 %},{% endif %}
      {{ mrn | default: medical_record_number | fhir_identifier: 'MRN' | json }}
      {% assign id_count = id_count | plus: 1 %}
    {% endif %}
    {% if identifier_value %}
      {% if id_count > 0 %},{% endif %}
      {
        "system": "{{ identifier_system | default: 'urn:oid:1.2.3.4.5' }}",
        "value": "{{ identifier_value }}"
      }
    {% endif %}
  ],
  "active": {{ active | default: true }},
  "name": [
    {% if full_name %}
      {{ full_name | fhir_name_parts | json }}
    {% elsif names %}
      {% for name in names %}
        {
          "use": "{{ name.use | default: 'official' }}",
          "family": "{{ name.family }}",
          "given": {{ name.given | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% else %}
      {
        "use": "official",
        "family": "{{ family_name }}",
        "given": {{ given_names | json }}
      }
    {% endif %}
  ]
  {% comment %} All optional fields below use leading comma pattern {% endcomment %}
  {% if gender %}
    ,{% assign gender_lower = gender | downcase %}
    {% if gender_lower == 'm' or gender_lower == 'male' %}
    "gender": "male"
    {% elsif gender_lower == 'f' or gender_lower == 'female' %}
    "gender": "female"
    {% elsif gender_lower == 'o' or gender_lower == 'other' %}
    "gender": "other"
    {% elsif gender_lower == 'u' or gender_lower == 'unknown' %}
    "gender": "unknown"
    {% else %}
    "gender": "{{ gender | fhir_code: 'gender' }}"
    {% endif %}
  {% endif %}
  {% if birth_date %}
    ,"birthDate": "{{ birth_date | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
  {% elsif date_of_birth %}
    ,"birthDate": "{{ date_of_birth | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' }}"
  {% endif %}
  {% if phone or mobile or email %}
    ,"telecom": [
      {% assign telecom_count = 0 %}
      {% if phone %}
        {{ phone | fhir_phone: 'home' | json }}
        {% assign telecom_count = telecom_count | plus: 1 %}
      {% endif %}
      {% if mobile %}
        {% if telecom_count > 0 %},{% endif %}
        {{ mobile | fhir_phone: 'mobile' | json }}
        {% assign telecom_count = telecom_count | plus: 1 %}
      {% endif %}
      {% if email %}
        {% if telecom_count > 0 %},{% endif %}
        {
          "system": "email",
          "value": "{{ email }}",
          "use": "home"
        }
      {% endif %}
    ]
  {% endif %}
  {% if simple_address or address or addresses %}
    ,"address": [
      {% if simple_address %}
        {{ simple_address | fhir_address | json }}
      {% elsif address %}
        {
          "use": "{{ address.use | default: 'home' }}",
          "line": {{ address.line | default: address.lines | json }},
          "city": "{{ address.city }}",
          "state": "{{ address.state }}",
          "postalCode": "{{ address.postal_code | default: address.postalCode }}",
          "country": "{{ address.country | default: 'US' }}"
        }
      {% elsif addresses %}
        {% for addr in addresses %}
          {
            "use": "{{ addr.use | default: 'home' }}",
            "line": {{ addr.line | default: addr.lines | json }},
            "city": "{{ addr.city }}",
            "state": "{{ addr.state }}",
            "postalCode": "{{ addr.postal_code | default: addr.postalCode }}",
            "country": "{{ addr.country | default: 'US' }}"
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      {% endif %}
    ]
  {% endif %}
}
