{
  "resourceType": "MedicationRequest",
  "id": "{{ id | default: uuid }}",
  "status": "{{ status | default: 'active' }}",
  "intent": "{{ intent | default: 'order' }}",

  {% comment %} Subject reference {% endcomment %}
  "subject": {
    "reference": "{{ patient_id | fhir_reference: 'Patient' }}"
  },

  {% comment %} Medication reference or codeable concept {% endcomment %}
  {% if medication_reference %}
  "medicationReference": {
    "reference": "{{ medication_reference | fhir_reference: 'Medication' }}"
  },
  {% else %}
  "medicationCodeableConcept": {
    "coding": [
      {
        "system": "{{ medication_system | default: 'http://www.nlm.nih.gov/research/umls/rxnorm' }}",
        "code": "{{ medication_code }}",
        "display": "{{ medication_display }}"
      }
    ]
  },
  {% endif %}

  {% comment %} Authored date {% endcomment %}
  "authoredOn": "{{ authored_on | fhir_date: 'MM/dd/yyyy', 'yyyy-MM-dd' | default: now }}"

  {% comment %} Requester {% endcomment %}
  {% if requester_id %}
  ,"requester": {
    "reference": "{{ requester_id | fhir_reference: 'Practitioner' }}"
  }
  {% endif %}

  {% comment %} Dosage instructions {% endcomment %}
  {% if dosage_text or dosage_route or dosage_value %}
  ,"dosageInstruction": [
    {
      {% assign dosage_prop_count = 0 %}
      {% if dosage_text %}
      "text": "{{ dosage_text }}"
      {% assign dosage_prop_count = dosage_prop_count | plus: 1 %}
      {% endif %}

      {% if dosage_route %}
      {% if dosage_prop_count > 0 %},{% endif %}
      "route": {
        "coding": [
          {
            "system": "http://snomed.info/sct",
            "code": "{{ dosage_route_code }}",
            "display": "{{ dosage_route }}"
          }
        ]
      }
      {% assign dosage_prop_count = dosage_prop_count | plus: 1 %}
      {% endif %}

      {% if dosage_value and dosage_unit %}
      {% if dosage_prop_count > 0 %},{% endif %}
      "doseAndRate": [
        {
          "type": {
            "coding": [
              {
                "system": "http://terminology.hl7.org/CodeSystem/dose-rate-type",
                "code": "ordered",
                "display": "Ordered"
              }
            ]
          },
          "doseQuantity": {
            "value": {{ dosage_value }},
            "unit": "{{ dosage_unit }}",
            "system": "http://unitsofmeasure.org",
            "code": "{{ dosage_unit | fhir_unit }}"
          }
        }
      ]
      {% assign dosage_prop_count = dosage_prop_count | plus: 1 %}
      {% endif %}

      {% if dosage_frequency %}
      {% if dosage_prop_count > 0 %},{% endif %}
      "timing": {
        "repeat": {
          "frequency": {{ dosage_frequency }},
          "period": 1,
          "periodUnit": "d"
        }
      }
      {% endif %}
    }
  ]
  {% endif %}

  {% comment %} Dispense request {% endcomment %}
  {% if dispense_quantity %}
  ,"dispenseRequest": {
    "quantity": {
      "value": {{ dispense_quantity }},
      "unit": "{{ dispense_unit | default: 'Tab' }}"
    }
  }
  {% endif %}
}
